<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting System</title>
</head>
<body>

    <h1>Voting System</h1>

    <!-- Registration Form -->
    <form id="registerForm">
        <h2>Register</h2>
        <label for="email">Email:</label>
        <input type="email" id="email" required><br><br>

        <label for="password">Password:</label>
        <input type="password" id="password" required><br><br>

        <button type="button" onclick="registerUser()">Register & Verify Email</button>
    </form>

    <br>

    <!-- Sign-In Form -->
    <form id="loginForm">
        <h2>Sign In</h2>
        <label for="loginEmail">Email:</label>
        <input type="email" id="loginEmail" required><br><br>

        <label for="loginPassword">Password:</label>
        <input type="password" id="loginPassword" required><br><br>

        <button type="button" onclick="signInUser()">Sign In</button>
    </form>

    <br>

    <!-- Voting Form (Hidden Until Verified & Signed In) -->
    <form id="voteForm" style="display: none;">
        <h2>Vote Now</h2>
        <label for="vote">Choose your option:</label>
        <select id="vote" required>
            <option value="option1">Option 1</option>
            <option value="option2">Option 2</option>
            <option value="option3">Option 3</option>
        </select><br><br>

        <button type="button" onclick="submitVote()">Submit Vote</button>
        <button type="button" onclick="logoutUser()">Logout</button>
    </form>

    <br>

    <!-- Winner Section -->
    <button onclick="determineWinner()">Get Winner</button>
    <h2 id="winner"></h2>

    <script type="module">
        // Import Firebase Modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getCountFromServer, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDq25s4TJM5ak_Pxc6wmlS_C_gsw8cXjHw",
            authDomain: "voting-website-5d65c.firebaseapp.com",
            projectId: "voting-website-5d65c",
            storageBucket: "voting-website-5d65c.appspot.com",
            messagingSenderId: "329997409751",
            appId: "1:329997409751:web:f8851f8ba1324ad5d5ff92",
            measurementId: "G-9F0VD8XJDK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Function to Register User and Send Email Verification
        async function registerUser() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await sendEmailVerification(user);
                alert("Verification email sent! Please verify your email before signing in.");

            } catch (error) {
                alert(error.message);
            }
        }

        // Function to Sign In User
        async function signInUser() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                if (!user.emailVerified) {
                    alert("Please verify your email before signing in.");
                    await signOut(auth);
                    return;
                }

                alert("Sign-In successful! You can now vote.");
                document.getElementById("voteForm").style.display = "block";

            } catch (error) {
                alert(error.message);
            }
        }

        // Check if User is Verified Before Showing the Vote Form
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (user.emailVerified) {
                    document.getElementById("voteForm").style.display = "block";
                } else {
                    alert("Please verify your email before voting.");
                    await signOut(auth);
                }
            }
        });

        // Function to Submit Vote
        async function submitVote() {
            const user = auth.currentUser;
            if (!user || !user.emailVerified) {
                alert("You must verify your email before voting.");
                return;
            }

            const email = user.email;
            const vote = document.getElementById("vote").value;

            // Check if the user has already voted
            const voteRef = doc(db, "votes", email);
            const voteDoc = await getDoc(voteRef);

            if (voteDoc.exists()) {
                alert("You have already voted!");
                return;
            }

            // Store the vote
            await setDoc(voteRef, { email, vote });

            alert("Vote submitted successfully!");
            await signOut(auth);
            window.location.reload();
        }

        // Function to Count Votes for Each Option
        async function countVotes(option) {
            const votesRef = collection(db, "votes");
            const q = query(votesRef, where("vote", "==", option));
            const snapshot = await getCountFromServer(q);
            return snapshot.data().count;
        }

        // Function to Determine the Winner
        async function determineWinner() {
            const options = ["option1", "option2", "option3"]; // List of vote options
            let maxVotes = 0;
            let winner = "No votes yet!";

            for (const option of options) {
                const voteCount = await countVotes(option);
                console.log(${option}: ${voteCount} votes);
                if (voteCount > maxVotes) {
                    maxVotes = voteCount;
                    winner = option;
                }
            }

            document.getElementById("winner").innerText = Winner: ${winner} with ${maxVotes} votes!;
        }

        // Function to Logout
        async function logoutUser() {
            await signOut(auth);
            alert("You have been logged out.");
            window.location.reload();
        }

        // Attach functions to window so they are accessible in HTML
        window.registerUser = registerUser;
        window.signInUser = signInUser;
        window.submitVote = submitVote;
        window.determineWinner = determineWinner;
        window.logoutUser = logoutUser;
    </script>

</body>
</html>
